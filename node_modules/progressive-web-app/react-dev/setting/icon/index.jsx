import React, {Component} from 'react';

import './style.scss';

class Icon extends Component
{
    constructor(props)
    {
        super(props);

        let {default_v=''}=this.props;

        this.state=
        {
            'icon_url':default_v
        }

        this.receiveFile=this.receiveFile.bind(this);
        this.openUploader=this.openUploader.bind(this);
        this.stateSetter=this.stateSetter.bind(this);
    }

    stateSetter(ob)
    {
        this.setState(ob);
    }

    receiveFile(e)
    {
        let {onChange}=this.props;
        let stateSetter=this.stateSetter;

        let f=e.currentTarget;

        if(!f.files || !f.files[0]){return;}

        /* Check file format */
        if(f.files[0].type!=='image/png')
        {
            alert('Only PNG allowed.');
            return;
        }

        /* Now render the image file in browser */
        let reader = new FileReader();
        reader.onload=function(e) 
        {
            let result=e.target.result;

            let img=new Image();

            img.onload=function()
            {
                if(this.width<512 || this.height<512 || this.width!==this.height)
                {
                    alert('Image must be square and at least 512px.');
                    return;
                }

                // State setter
                stateSetter({'icon_url':result});

                // Pass to parent
                onChange(false, {'icon':f.files[0]});
            }
            
            img.src=result;
        }
        reader.readAsDataURL(f.files[0]);
    }

    openUploader()
    {
        this.uploadInput.click();
    }

    render()
    {
        let {icon_url}=this.state;

        return <div id="pwa_icon_insert_module">
            <small>PNG, Squire, Min. 512px</small>
            <input type="file" accept=".png" ref={el=>this.uploadInput=el} onChange={this.receiveFile}/>

            <img src={icon_url}/>

            <button className="btn btn-outline-secondary btn-sm" onClick={this.openUploader}>
                {icon_url ? 'Change' : 'Select'} Image
            </button>
        </div>
    }
}

export {Icon}