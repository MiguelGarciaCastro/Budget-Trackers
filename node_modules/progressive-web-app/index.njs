const build_folder  = nr_project_root+'/build/manifest.json';
const public_folder = nr_project_root+'/public/manifest.json';

const nr_create_admin_page=function($, next)
{
    var sub_page=
    {
        'page_title':'Progressive Web App', 
        'menu_title':'PWA', 
        'slug':'progressive-web-app',
        'component':'Dashboard', 
        'package':'progressive-web-app',
        'parent_slug':'settings'
    }

    $.add_submenu_page(sub_page);

    next($);
}

const get_manifest=function(next)
{
    var func=function(content)
    {
        try{content=JSON.parse(content)}catch(e){}
        typeof content!=='object' ? content={} : 0;

        (content.icons && content.icons[0]) ? content.icon_url='/'+content.icons[0].src : 0;
        
        next(content);
    }

    // Check if exist in build
    file_get_contents(build_folder, function(content)
    {
        if(content)
        {
            func(content);
            return;
        }
        
        // Check if exist in public otherwise
        file_get_contents(public_folder, function(content)
        {
            func(content);
        });
    });
}

const provide_manifest=($, next)=>
{
    get_manifest(function(content)
    {
        $.echo({'manifest':content});
        next($);
    });
}

const save_manifest=function($, next)
{
    var json=
    {
        short_name      : $._POST.short_name,  
        name            : $._POST.name,  
        start_url       : '.',  
        display         : $._POST.display,  
        theme_color     : $._POST.theme_color,  
        background_color: $._POST.background_color,  
        orientation     : $._POST.orientation
    };

    // Store manifest file paths
    var man_path=[nr_project_root+'/public/', nr_project_root+'/build/'];

    if($._FILES['icon'])
    {
        // Gather data
        var name        = 'pwa-icon.png';
        var icon_path   = man_path[0]+name;
        var path        = $._FILES['icon'].path;

        // Put the file name in manifest object
        json.icons=
        [{
            "src"   : name,
            "sizes" : "72x72 96x96 120x120 128x128 144x144 152x152 180x180 192x192 384x384 512x512",
            "type"  : "image/png"
        }];

        // Put uploaded icon file in public folder
        node_modules.fs.rename(path, icon_path, e=>
        {
            // Then copy the file to build folder
            !e ? node_modules.fs.copyFile(icon_path, man_path[1]+name, e=>{}) : 0;  
        });
    }

    get_manifest(function(manifest)
    {
        for(var k in json)
        {
            manifest[k]=json[k];
        };

        delete manifest.icon_url;
        
        node_modules.fs.writeFile(build_folder, JSON.stringify(manifest), e=>{});
        node_modules.fs.writeFile(public_folder, JSON.stringify(manifest), e=>{});
    });
    
    next($);
}

module.exports.run=function($, next)
{
    $.add_action('admin_menu', nr_create_admin_page);

    $.add_action('nr_ajax_nr_pwa_save_manifest', save_manifest);
    $.add_action('nr_ajax_nr_pwa_get_manifest_file', provide_manifest);

    next($);
}